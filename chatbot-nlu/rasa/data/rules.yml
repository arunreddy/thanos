version: "3.1"

rules:
  - rule: Say goodbye anytime the user says goodbye
    steps:
      - intent: goodbye
      - action: utter_goodbye

  - rule: Say hello anytime the user says hello
    steps:
      - intent: greet
      - action: utter_greet

  # ─── catch fallback inside select form ───
  - rule: nlu fallback in select form
    condition:
      - active_loop: recommend_database_form
    steps:
      - intent: nlu_fallback
      - action: action_listen

  # ─── catch fallback inside create form ───
  - rule: nlu fallback in create form
    condition:
      - active_loop: create_database_form
    steps:
      - intent: nlu_fallback
      - action: action_listen

  # ─── catch fallback inside delete form ───
  - rule: nlu fallback in delete form
    condition:
      - active_loop: delete_database_form
    steps:
      - intent: nlu_fallback
      - action: action_listen

  # ─── global nlu fallback when no form is active ───
  - rule: global nlu fallback
    condition:
      - active_loop: null
    steps:
      - intent: nlu_fallback
      - action: utter_oos

  # ─── global out_of_scope fallback when no form is active ───
  - rule: global out_of_scope fallback
    condition:
      - active_loop: null
    steps:
      - intent: out_of_scope
      - action: utter_oos

  # ─── guarded restart ───
  - rule: Restart the conversation
    condition:
      - active_loop: null
    steps:
      - intent: restart
      - action: action_restart

  - rule: Interrupt with help and resume flow
    condition:
      - active_loop: null
    steps:
      - intent: help
      - action: utter_help

  - rule: Help website flow
    condition:
      - active_loop: null
    steps:
      - intent: help_website
      - action: utter_help_website

# ——— recommend database form ———
  - rule: Activate recommend database form
    steps:
      - intent: recommend_database
      - action: recommend_database_form
      - active_loop: recommend_database_form

  - rule: Handle confirmation of database selection
    condition:
      - active_loop: null
    steps:
      - intent: confirm_database_selection
      - action: action_recommend_database_create_ticket

  - rule: Submit select database form
    condition:
      - active_loop: recommend_database_form
      - slot_was_set:
          - downtime_tolerance
    steps:
      - action: recommend_database_form
      - active_loop: null
      - action: action_recommend_database
      - action: utter_database_selection_confirmation

# ——— create‐database form ———
  - rule: Activate create database form
    steps:
      - intent: create_database
      - action: create_database_form
      - active_loop: create_database_form

  - rule: Submit create database form
    condition:
      - active_loop: create_database_form
      - slot_was_set:
          - sysid           # ← not `requested_slot`
    steps:
      - action: create_database_form
      - active_loop: null
      - action: utter_ask_confirm_database_creation
      - action: action_listen

  - rule: Handle affirm for database creation
    condition:
      - active_loop: null
      - slot_was_set:
          - database_name
          - database_version
          - sysid
    steps:
      - intent: affirm
      - action: action_submit_database

  # Handle rejection (cancellation) for database creation
  - rule: Handle deny for database creation
    condition:
      - active_loop: null
      - slot_was_set:
          - database_name
          - database_version
          - sysid
    steps:
      - intent: deny
      - action: utter_database_creation_cancelled


# ——— delete‐database form ———
  - rule: Activate delete database form
    steps:
      - intent: delete_database
      - action: delete_database_form
      - active_loop: delete_database_form

  - rule: Submit delete database form
    condition:
      - active_loop: delete_database_form
      - slot_was_set:
          - sysid
    steps:
      - action: delete_database_form
      - active_loop: null
      - action: action_submit_delete_database
