version: "3.1"

rules:
  - rule: Say goodbye anytime the user says goodbye
    steps:
      - intent: goodbye
      - action: utter_goodbye

  - rule: Say hello anytime the user says hello
    steps:
      - intent: greet
      - action: utter_greet

  # ─── catch fallback inside select form ───
  - rule: nlu fallback in select form
    condition:
      - active_loop: select_database_form
    steps:
      - intent: nlu_fallback
      - action: action_listen

  # ─── catch fallback inside create form ───
  - rule: nlu fallback in create form
    condition:
      - active_loop: create_database_form
    steps:
      - intent: nlu_fallback
      - action: action_listen

  # ─── catch fallback inside delete form ───
  - rule: nlu fallback in delete form
    condition:
      - active_loop: delete_database_form
    steps:
      - intent: nlu_fallback
      - action: action_listen

  # ─── global fallback (when no form is active) ───
  - rule: global nlu fallback
    condition:
      - active_loop: null
    steps:
      - intent: nlu_fallback
      - action: utter_oos

  # ─── then your guarded restart ───
  - rule: Restart the conversation
    condition:
      - active_loop: null
    steps:
      - intent: restart
      - action: action_restart

  - rule: Interrupt with help and resume flow
    condition:
      - active_loop: null
    steps:
      - intent: help
      - action: utter_help

  - rule: Help website flow
    condition:
      - active_loop: null
    steps:
      - intent: help_website
      - action: utter_help_website

  # ——— select-database form ———
  - rule: Activate select database form
    steps:
      - intent: start_database_selection
      - action: select_database_form
      - active_loop: select_database_form

  - rule: Submit select database form
    condition:
      - active_loop: select_database_form
      - slot_was_set:
          - downtime_tolerance
    steps:
      - action: select_database_form
      - active_loop: null
      - action: action_recommend_database
      - action: action_submit_request

  # ——— create-database form ———
  - rule: Activate create database form
    steps:
      - intent: create_database
      - action: create_database_form
      - active_loop: create_database_form

  - rule: Submit create database form
    condition:
      - active_loop: create_database_form
      - slot_was_set:
          - sysid
    steps:
      - action: create_database_form
      - active_loop: null
      - action: action_submit_database

  # ——— delete-database form ———
  - rule: Activate delete database form
    steps:
      - intent: delete_database
      - action: delete_database_form
      - active_loop: delete_database_form

  - rule: Submit delete database form
    condition:
      - active_loop: delete_database_form
      - slot_was_set:
          - sysid
    steps:
      - action: delete_database_form
      - active_loop: null
      - action: action_submit_delete_database
